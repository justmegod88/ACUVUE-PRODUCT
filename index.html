<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ì œí’ˆ í´ë¦­ â†’ 360Â° ë Œì¦ˆ + ëˆˆê¹œë°•ì„ ì•ˆì°©</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --surface:#ffffff;
      --text:#0b1220;
      --muted:#5b6475;

      --brand:#0b4aa2;
      --brand2:#1e78ff;

      --line:#e6e9f2;
      --shadow: 0 10px 28px rgba(16,24,40,0.10);
      --shadow2: 0 6px 16px rgba(16,24,40,0.08);

      --radius: 18px;
      --green:#18a85b;
      --green2:#0f8b49;

      --max: 760px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(30,120,255,0.12), transparent 60%),
                  radial-gradient(900px 450px at 90% 0%, rgba(11,74,162,0.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",Arial,sans-serif;
      line-height:1.35;
    }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 18px 16px 44px; }

    header{
      position: sticky; top: 0; z-index: 5;
      padding: 12px 0 12px;
      backdrop-filter: blur(10px);
      background: rgba(246,248,252,0.72);
      border-bottom: 1px solid rgba(230,233,242,0.75);
    }
    .headRow{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .brandBox{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .brandBox .title{ font-weight:950; letter-spacing:-0.45px; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandBox .sub{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pill{
      font-size:12px; padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,0.9);
      box-shadow: 0 2px 10px rgba(16,24,40,0.06);
      flex: 0 0 auto;
    }

    .card{
      background: var(--surface);
      border: 1px solid rgba(230,233,242,0.9);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .listTitle{
      font-size:18px;
      font-weight:980;
      letter-spacing:-0.6px;
      margin: 8px 0 10px;
    }

    .productCard{
      border: 1px solid rgba(230,233,242,0.95);
      border-radius: 16px;
      padding: 14px;
      display:flex;
      gap:12px;
      align-items:center;
      box-shadow: var(--shadow2);
      background: rgba(255,255,255,0.96);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .productCard:active{ transform: scale(0.99); }
    .productCard:hover{ box-shadow: 0 12px 26px rgba(16,24,40,0.10); }

    .pThumb{
      width: 86px;
      height: 52px;
      border-radius: 12px;
      border: 1px solid rgba(230,233,242,0.95);
      background:
        radial-gradient(120px 60px at 30% 30%, rgba(30,120,255,0.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.72));
      display:grid;
      place-items:center;
      font-weight:950;
      color: rgba(11,74,162,0.9);
      letter-spacing:-0.2px;
      flex: 0 0 auto;
      text-align:center;
      font-size:12px;
      line-height:1.05;
    }
    .pInfo{ min-width:0; flex:1; }
    .pName{ font-weight:980; letter-spacing:-0.4px; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pDesc{ margin-top:4px; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chips{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      font-size:12px;
      padding:7px 10px;
      border-radius: 999px;
      background: rgba(11,74,162,0.06);
      border: 1px solid rgba(11,74,162,0.10);
      color: rgba(11,74,162,0.95);
      font-weight: 900;
      letter-spacing:-0.2px;
    }
    .arrow{
      width: 34px; height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(230,233,242,0.95);
      background: rgba(255,255,255,0.92);
      display:grid;
      place-items:center;
      color: rgba(11,74,162,0.9);
      font-weight: 950;
      box-shadow: var(--shadow2);
      flex: 0 0 auto;
    }
    .gap{ height: 12px; }

    /* ========== MODAL ========== */
    .modal{
      position: fixed; inset:0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modal.open{ display:flex; }

    .modalBox{
      width:100%;
      max-width: 700px;
      background:#fff;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(230,233,242,0.95);
      box-shadow: var(--shadow);
      transform: translateY(6px) scale(0.99);
      opacity: 0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .modal.open .modalBox{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modalTop{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(230,233,242,0.95);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
    }
    .modalTop .t{ font-weight: 980; letter-spacing:-0.3px; }

    .x{
      border:1px solid rgba(230,233,242,0.95);
      background:#fff;
      font-size:14px;
      font-weight:950;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow2);
    }

    .stage{
      position: relative;
      width:100%;
      aspect-ratio: 3 / 4;
      background:
        radial-gradient(720px 360px at 50% 8%, rgba(30,120,255,0.22), transparent 62%),
        radial-gradient(660px 360px at 0% 40%, rgba(11,74,162,0.12), transparent 60%),
        linear-gradient(180deg, #1a2636 0%, #0f1726 100%);
      overflow:hidden;
      touch-action: none;
    }

    .headerBar{
      position:absolute;
      left:10px; right:10px; top:10px;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(230,233,242,0.9);
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(10px);
      pointer-events:none;
      z-index: 6;
    }
    .headerBar .name{
      font-weight:980; letter-spacing:-0.2px; font-size:13px;
      color: var(--text);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .points{
      position:absolute;
      right: 10px;
      top: 56px;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:auto;
      z-index: 7;
    }
    .ptBtn{
      width: 46px; height: 46px;
      border-radius: 999px;
      border: 1px solid rgba(230,233,242,0.95);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .ptBtn.active{
      border-color: rgba(11,74,162,0.35);
      box-shadow: 0 10px 24px rgba(11,74,162,0.18);
      transform: translateY(-1px);
    }
    .ptIcon{
      width: 28px; height: 28px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-size: 12px;
      background: rgba(11,74,162,0.10);
      border: 1px solid rgba(11,74,162,0.16);
      font-weight: 950;
    }

    /* 3D viewport */
    #view3d{
      position:absolute;
      left: 50%;
      top: 41%;
      transform: translate(-50%,-50%);
      width: min(88vw, 540px);
      height: min(88vw, 540px);
      filter: drop-shadow(0 22px 30px rgba(0,0,0,0.22));
      z-index: 2;
      border-radius: 999px;
      overflow: visible;
    }
    canvas{ display:block; }

    /* eye overlay */
    .eyeOverlay{
      position:absolute;
      left: 50%;
      top: 41%;
      transform: translate(-50%,-50%);
      width: min(88vw, 540px);
      height: min(62vw, 380px);
      pointer-events:none;
      z-index: 5;
    }
    .eyeShape{
      position:absolute; inset:0;
      border-radius: 999px;
      background:
        radial-gradient(60% 80% at 50% 50%, rgba(255,255,255,0.08), rgba(255,255,255,0.00) 60%),
        radial-gradient(40% 50% at 50% 50%, rgba(30,120,255,0.08), transparent 70%);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
      clip-path: ellipse(48% 38% at 50% 50%);
    }
    .lidTop, .lidBottom{
      position:absolute;
      left: 0; right: 0;
      height: 52%;
      background: linear-gradient(180deg, rgba(15,23,38,0.98), rgba(15,23,38,0.60));
      opacity: 0;
      transform: translateY(-18%);
      transition: opacity .18s ease, transform .18s ease;
      border-radius: 999px;
    }
    .lidBottom{
      bottom:0;
      background: linear-gradient(0deg, rgba(15,23,38,0.98), rgba(15,23,38,0.60));
      transform: translateY(18%);
    }
    .blink .lidTop{ opacity: 1; transform: translateY(22%); }
    .blink .lidBottom{ opacity: 1; transform: translateY(-22%); }

    /* bottom info panel */
    .greenPanel{
      position:absolute;
      left:0; right:0;
      bottom: 60px;
      margin: 0 10px;
      background: linear-gradient(180deg, var(--green), var(--green2));
      color:#fff;
      border-radius: 14px;
      padding: 10px 14px;
      box-shadow: var(--shadow);
      pointer-events:none;
      z-index: 6;
    }
    .greenTitle{
      font-weight:980;
      letter-spacing:-0.45px;
      font-size: 14px;
      margin:0 0 6px;
      line-height:1.15;
      text-align:center;
    }
    .greenBody{
      font-size: 12.5px;
      line-height:1.45;
      opacity: 0.96;
      text-align:center;
    }
    .greenSubBox{
      margin: 7px auto 0;
      max-width: 92%;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.18);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      line-height:1.45;
      text-align:center;
      opacity:0.95;
    }

    .badgeRow{
      margin-top: 7px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    .badge{
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.20);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:-0.2px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
    }

    .modalBottom{
      padding: 12px 14px 14px;
      border-top: 1px solid rgba(230,233,242,0.95);
      display:grid;
      gap: 10px;
      background: rgba(255,255,255,0.98);
    }
    .status{
      font-size: 13px;
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .status b{ color: var(--text); }

    .btn{
      width:100%;
      border:0;
      border-radius: 14px;
      padding: 13px 14px;
      font-size: 15px;
      font-weight: 950;
      background: linear-gradient(180deg, var(--brand2), var(--brand));
      color: #fff;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(11,74,162,0.22);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,0.96);
      color: var(--text);
      border:1px solid var(--line);
      font-weight: 950;
      box-shadow: var(--shadow2);
    }
    .actionRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:stretch;
    }

    /* small toggle row */
    .toggleRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .miniHelp{ font-size:12px; color:var(--muted); line-height:1.45; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="headRow">
        <div class="brandBox">
          <div class="title">ì•Œë¦¼í†¡ ëœë”© (í…ŒìŠ¤íŠ¸)</div>
          <div class="sub">ì œí’ˆ ì¹´ë“œ í´ë¦­ â†’ 360Â° íšŒì „ + ëˆˆ ê¹œë°•ì„(ì•ˆì°©)</div>
        </div>
        <div class="pill">GitHub Pages OK</div>
      </div>
    </header>

    <section>
      <div class="card">
        <div class="listTitle">ì½˜íƒíŠ¸ë Œì¦ˆ</div>

        <div class="productCard" data-product="toric_demo">
          <div class="pThumb">TORIC<br>DEMO</div>
          <div class="pInfo">
            <div class="pName">ë‚œì‹œ ë Œì¦ˆ(ë°ëª¨)</div>
            <div class="pDesc">360Â° íšŒì „ + í•«ìŠ¤íŒŸ 3ê°œ + ëˆˆê¹œë°•ì„ ì•ˆì°©</div>
            <div class="chips">
              <div class="chip">#ë“œë˜ê·¸íšŒì „</div>
              <div class="chip">#í•«ìŠ¤íŒŸ3</div>
              <div class="chip">#ê¹œë°•ì„</div>
            </div>
          </div>
          <div class="arrow">â€º</div>
        </div>

        <div class="gap"></div>

        <div style="font-size:12px; color:var(--muted);">
          * ì´ë¯¸ì§€ íŒŒì¼ì€ <b>/assets/lens_front.jpg</b>, <b>/assets/lens_angle.jpg</b> ë¡œ ë„£ì–´ì¤˜.
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div class="modal" id="resultModal" aria-hidden="true">
    <div class="modalBox">
      <div class="modalTop">
        <div class="t">ì œí’ˆ í”„ë¦¬ë·°</div>
        <button class="x" id="btnClose">ë‹«ê¸°</button>
      </div>

      <div class="stage" id="stage">
        <div class="headerBar">
          <div class="name" id="productTop">ë‚œì‹œ ë Œì¦ˆ(ë°ëª¨)</div>
          <div class="name" style="font-weight:900; color: rgba(255,255,255,.0); font-size:12px;"></div>
        </div>

        <!-- Hotspot buttons -->
        <div class="points" id="points"></div>

        <!-- 3D -->
        <div id="view3d"></div>

        <!-- eye overlay -->
        <div class="eyeOverlay" id="eyeOverlay">
          <div class="eyeShape"></div>
          <div class="lidTop"></div>
          <div class="lidBottom"></div>
        </div>

        <!-- info -->
        <div class="greenPanel">
          <div class="greenTitle" id="greenTitle"></div>
          <div class="greenBody" id="greenBody"></div>

          <div class="badgeRow" id="badgeRow" style="display:none;">
            <div class="badge" id="badgeText"></div>
          </div>

          <div class="greenSubBox" id="greenSub"></div>
        </div>
      </div>

      <div class="modalBottom">
        <div class="status">
          <span>ìƒíƒœ: <b id="statusText">ëŒ€ê¸°</b></span>
          <span>ì¡°ì‘: <b>ë“œë˜ê·¸(360Â°)</b></span>
        </div>

        <div class="toggleRow">
          <button class="btn secondary" id="btnFront">ì •ë©´ ë³´ê¸°</button>
          <button class="btn secondary" id="btnAngle">ì‚¬ì„  ë³´ê¸°</button>
        </div>

        <div class="actionRow">
          <button class="btn secondary" id="btnBack">ëª©ë¡ìœ¼ë¡œ</button>
          <button class="btn" id="btnBlink">ëˆˆ ê¹œë°•ì„(ì•ˆì°©)</button>
        </div>

        <div class="miniHelp">
          * â€œëˆˆ ê¹œë°•ì„â€ì„ ëˆ„ë¥´ë©´ ëˆˆêº¼í’€ì´ ë‹«í˜”ë‹¤ ì—´ë¦¬ë©´ì„œ ë Œì¦ˆê°€ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤ëƒ…(ì•ˆì°©)ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
    import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";

    // =========================
    // ì´ë¯¸ì§€ ê²½ë¡œ (ë ˆí¬ì— ë„£ëŠ” íŒŒì¼)
    // =========================
    const ASSETS = {
      front: "assets/lens_front.jpg",
      angle: "assets/lens_angle.jpg"
    };

    // =========================
    // ì œí’ˆ ë°ì´í„° (í…ŒìŠ¤íŠ¸ìš©)
    // =========================
    const PRODUCT = {
      name: "ë‚œì‹œ ë Œì¦ˆ(ë°ëª¨)",
      badge: "360Â° íšŒì „ + ëˆˆê¹œë°•ì„ ì•ˆì°©",
      default: {
        title: "ì†ê°€ë½ìœ¼ë¡œ 360Â° íšŒì „í•˜ê³ , ê¹œë°•ì„ìœ¼ë¡œ â€˜ì•ˆì°©â€™ì„ ì²´í—˜",
        body: "í•«ìŠ¤íŒŸ 3ê°œë¡œ í•µì‹¬ë§Œ ë¹ ë¥´ê²Œ ë³´ì—¬ì£¼ê³ , ì‚¬ìš©/ê´€ë¦¬/ì£¼ì˜ì‚¬í•­ì€ ì•„ë˜ ë°•ìŠ¤ì— ì´ì–´ì„œ ë°°ì¹˜ ê°€ëŠ¥",
        sub: "â€» ë¬¸êµ¬ëŠ” ë„ˆê°€ ì£¼ë©´ ê·¸ëŒ€ë¡œ êµì²´"
      },
      points: [
        { icon:"ğŸ¯", key:"hot1", title:"í•«ìŠ¤íŒŸ 1", body:"(ì˜ˆì‹œ) ë””ìì¸/í‘œì‹ ê´€ë ¨ í¬ì¸íŠ¸", sub:"ì¶”í›„ êµì²´" },
        { icon:"ğŸ’§", key:"hot2", title:"í•«ìŠ¤íŒŸ 2", body:"(ì˜ˆì‹œ) ì´‰ì´‰í•¨/ì•ˆì •í™” í¬ì¸íŠ¸", sub:"ì¶”í›„ êµì²´" },
        { icon:"ğŸ§¼", key:"care", title:"ê´€ë¦¬/ì£¼ì˜", body:"(ì˜ˆì‹œ) ì„¸ì²™Â·ë³´ê´€Â·êµì²´ì£¼ê¸° ì•ˆë‚´", sub:"ì›ë°ì´/2ì£¼/í•œë‹¬ ë“± ì œí’ˆë³„ë¡œ ë°”ê¿” ë„£ê¸°" }
      ]
    };

    // =========================
    // DOM
    // =========================
    const modal = document.getElementById("resultModal");
    const btnClose = document.getElementById("btnClose");
    const btnBack  = document.getElementById("btnBack");
    const productTop = document.getElementById("productTop");

    const pointsEl = document.getElementById("points");
    const greenTitle = document.getElementById("greenTitle");
    const greenBody  = document.getElementById("greenBody");
    const greenSub   = document.getElementById("greenSub");
    const badgeRow   = document.getElementById("badgeRow");
    const badgeText  = document.getElementById("badgeText");
    const eyeOverlay = document.getElementById("eyeOverlay");
    const statusText = document.getElementById("statusText");

    const btnBlink = document.getElementById("btnBlink");
    const btnFront = document.getElementById("btnFront");
    const btnAngle = document.getElementById("btnAngle");

    const view3d = document.getElementById("view3d");

    function openModal(){
      modal.classList.add("open");
      modal.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modal.classList.remove("open");
      modal.setAttribute("aria-hidden","true");
    }

    btnClose.addEventListener("click", closeModal);
    btnBack.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

    // =========================
    // UI helpers
    // =========================
    function setPanel({title, body, sub, badge}){
      greenTitle.textContent = title || "";
      greenBody.textContent  = body || "";
      greenSub.textContent   = sub || "";

      if(badge){
        badgeRow.style.display = "flex";
        badgeText.textContent = badge;
      }else{
        badgeRow.style.display = "none";
      }
    }

    function renderPoints(){
      pointsEl.innerHTML = "";
      PRODUCT.points.forEach((p, idx)=>{
        const btn = document.createElement("div");
        btn.className = "ptBtn";
        btn.innerHTML = `<div class="ptIcon">${p.icon}</div>`;
        btn.addEventListener("click", ()=>{
          [...pointsEl.children].forEach((el,i)=>el.classList.toggle("active", i===idx));
          setPanel({ title:p.title, body:p.body, sub:p.sub, badge: PRODUCT.badge });
        });
        pointsEl.appendChild(btn);
      });
    }

    // =========================
    // THREE.JS
    // =========================
    let renderer, scene, camera, controls;
    let lensMesh, ringMesh;
    let currentTexture = null;

    // blink settle
    let settling = false;
    let settleT = 0;
    const targetRot = new THREE.Euler(-0.15, 0, 0);

    function init3D(){
      scene = new THREE.Scene();

      const w = view3d.clientWidth;
      const h = view3d.clientHeight;

      camera = new THREE.PerspectiveCamera(35, w/h, 0.1, 100);
      camera.position.set(0, 0.2, 4.0);

      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
      renderer.setSize(w, h);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
      renderer.outputColorSpace = THREE.SRGBColorSpace;

      view3d.innerHTML = "";
      view3d.appendChild(renderer.domElement);

      // lights
      const key = new THREE.DirectionalLight(0xffffff, 1.1);
      key.position.set(2,2,3);
      scene.add(key);

      const fill = new THREE.DirectionalLight(0xffffff, 0.55);
      fill.position.set(-2,1,2);
      scene.add(fill);

      scene.add(new THREE.AmbientLight(0xffffff, 0.55));

      // controls (ì†ê°€ë½ ë“œë˜ê·¸ 360Â°)
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.07;
      controls.enablePan = false;
      controls.minDistance = 2.7;
      controls.maxDistance = 6.0;
      controls.rotateSpeed = 0.65;
      controls.target.set(0, 0, 0);

      // lens mesh (ì›íŒ + ë¬¼ì„±)
      const geo = new THREE.CircleGeometry(1.55, 128);
      const mat = new THREE.MeshPhysicalMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.92,
        roughness: 0.14,
        metalness: 0.0,
        transmission: 0.55,
        thickness: 0.6,
        clearcoat: 1.0,
        clearcoatRoughness: 0.12
      });
      lensMesh = new THREE.Mesh(geo, mat);
      lensMesh.rotation.x = -0.15;
      scene.add(lensMesh);

      // subtle ring
      const ringGeo = new THREE.RingGeometry(1.52, 1.58, 128);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.22 });
      ringMesh = new THREE.Mesh(ringGeo, ringMat);
      ringMesh.rotation.x = -0.15;
      scene.add(ringMesh);

      // resize
      window.addEventListener("resize", ()=>{
        if(!renderer) return;
        const w2 = view3d.clientWidth;
        const h2 = view3d.clientHeight;
        renderer.setSize(w2,h2);
        camera.aspect = w2/h2;
        camera.updateProjectionMatrix();
      });
    }

    function loadTexture(url){
      statusText.textContent = "ì´ë¯¸ì§€ ë¡œë”©";
      return new Promise((resolve, reject)=>{
        const loader = new THREE.TextureLoader();
        loader.load(
          url,
          (tex)=>{
            tex.colorSpace = THREE.SRGBColorSpace;
            tex.anisotropy = 8;
            resolve(tex);
          },
          undefined,
          (err)=>reject(err)
        );
      });
    }

    async function applyTexture(url){
      try{
        const tex = await loadTexture(url);
        if(currentTexture) currentTexture.dispose();
        currentTexture = tex;

        lensMesh.material.map = tex;
        lensMesh.material.needsUpdate = true;

        statusText.textContent = "ëŒ€ê¸°";
      }catch(e){
        statusText.textContent = "ì´ë¯¸ì§€ ì˜¤ë¥˜";
        console.error("Texture load error:", e);
        alert("ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨: assets í´ë” ê²½ë¡œ/íŒŒì¼ëª…ì„ í™•ì¸í•´ì¤˜.\nì˜ˆ) assets/lens_front.jpg");
      }
    }

    function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

    function doBlinkAndSettle(){
      statusText.textContent = "ì•ˆì°© ì¤‘";

      // eyelid blink
      eyeOverlay.classList.add("blink");
      setTimeout(()=> eyeOverlay.classList.remove("blink"), 220);

      // settle: íšŒì „ ì•ˆì •í™” + ì‚´ì§ 'ì°©' íš¨ê³¼
      settling = true;
      settleT = 0;
    }

    function animate(){
      requestAnimationFrame(animate);

      if(!controls.dragging){
        lensMesh.rotation.y += 0.0011;
        ringMesh.rotation.y += 0.0011;
      }

      if(settling){
        settleT += 0.035;
        const t = Math.min(settleT, 1);
        const k = easeOutCubic(t);

        lensMesh.rotation.x += (targetRot.x - lensMesh.rotation.x) * (0.08 + 0.22*k);
        lensMesh.rotation.y += (targetRot.y - lensMesh.rotation.y) * (0.08 + 0.22*k);
        lensMesh.rotation.z += (targetRot.z - lensMesh.rotation.z) * (0.08 + 0.22*k);

        const z = 0.10 * Math.sin(k * Math.PI);
        lensMesh.position.z = z;
        ringMesh.position.z = z;

        if(t >= 1){
          settling = false;
          lensMesh.position.z = 0;
          ringMesh.position.z = 0;
          statusText.textContent = "ëŒ€ê¸°";
        }
      }

      controls.update();
      renderer.render(scene, camera);
    }

    // =========================
    // OPEN FLOW
    // =========================
    async function openPreview(){
      productTop.textContent = PRODUCT.name;
      renderPoints();
      setPanel({ ...PRODUCT.default, badge: PRODUCT.badge });

      openModal();

      if(!renderer){
        init3D();
        await applyTexture(ASSETS.front);
        animate();
      }else{
        // ë‹¤ì‹œ ì—´ ë•ŒëŠ” ìƒíƒœë§Œ ì´ˆê¸°í™”
        statusText.textContent = "ëŒ€ê¸°";
      }
    }

    // product click
    document.querySelectorAll(".productCard").forEach(el=>{
      el.addEventListener("click", openPreview);
    });

    // buttons
    btnBlink.addEventListener("click", doBlinkAndSettle);

    btnFront.addEventListener("click", async ()=>{
      btnFront.classList.add("active");
      btnAngle.classList.remove("active");
      await applyTexture(ASSETS.front);
    });

    btnAngle.addEventListener("click", async ()=>{
      btnAngle.classList.add("active");
      btnFront.classList.remove("active");
      await applyTexture(ASSETS.angle);
    });

  </script>
</body>
</html>
