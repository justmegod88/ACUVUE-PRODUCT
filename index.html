<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ACUVUE GLB Viewer (Optician)</title>

  <style>
    html,body{height:100%;margin:0;background:#081625;overflow:hidden;font-family:-apple-system,system-ui;}
    model-viewer{width:100vw;height:100vh;background:transparent;display:block;}

    /* ìƒë‹¨ ë¯¸ì…˜ ì¹´ë“œ */
    #missionBar{
      position:fixed; left:12px; right:12px; top:12px; z-index:40;
      display:flex; gap:10px; align-items:stretch;
      pointer-events:auto;
    }
    .missionCard{
      flex:1;
      padding:12px 12px;
      border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:#eaf2ff;
      backdrop-filter: blur(8px);
      min-height:86px;
      box-sizing:border-box;

      /* âœ… í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    .missionCard:active{ transform: scale(.99); }

    /* âœ… ON ìƒíƒœ í‘œì‹œ */
    .missionCard.on{
      background:rgba(0,255,140,.12);
      border-color:rgba(0,255,140,.35);
    }

    .missionNo{font-weight:900;opacity:.85;font-size:14px;margin-bottom:6px;}
    .missionTitle{font-weight:900;font-size:16px;margin-bottom:6px;}
    .missionDesc{font-size:12.5px;line-height:1.35;opacity:.88;white-space:pre-line;}

    /* í•˜ë‹¨ ë²„íŠ¼ */
    #bottomBtns{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:50;
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .btn{
      flex:1;min-width:140px;
      padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#eaf2ff;font-weight:900;font-size:13px;
      -webkit-tap-highlight-color: transparent;
      backdrop-filter: blur(8px);
    }
    .btn.primary{ background:rgba(0,255,140,.12); border-color:rgba(0,255,140,.35); }

    /* ì‘ì€ ì›í˜• â†º ë²„íŠ¼ */
    #btnReset{
      width:46px;height:46px;min-width:46px;flex:0 0 auto;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:#eaf2ff;
      font-weight:900;
      font-size:16px;
      display:flex;align-items:center;justify-content:center;
      backdrop-filter: blur(8px);
      -webkit-tap-highlight-color: transparent;
    }

    /* ASD ì˜¤ë²„ë ˆì´ (blink.png) */
    #asdOverlay{
      position:fixed; inset:0; z-index:80;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      align-items:center; justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }
    #asdOverlay.show{ display:flex; }
    #asdCard{
      width:min(920px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(10,18,30,.62);
      overflow:hidden;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      position:relative;
    }
    #asdCard img{ width:100%; height:auto; display:block; background:rgba(255,255,255,.04); }
    #asdClose{
      position:absolute; right:10px; top:10px;
      width:38px; height:38px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:#eaf2ff;
      font-weight:900;
      -webkit-tap-highlight-color: transparent;
      z-index:6;
    }
    #asdHint{
      padding:10px 12px;
      color:#eaf2ff;
      font-size:12.5px;
      opacity:.9;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* âœ…âœ… ASD: eye_animation.glb + lens overlay */
    #asdScene{
      position:relative;
      width:100%;
      background:rgba(255,255,255,.04);
      overflow:hidden;
      aspect-ratio: 16/9;
      min-height: 320px;
       /* ğŸ”¥ ìŠ¤ìƒ· ê¸°ì¤€ ì •í™•íˆ ë§ì¶˜ ëˆˆ ëª¨ì–‘ í¬ë¡­ */
      clip-path: ellipse(50% 34% at 50% 52%);
    }

    /* ASD eye model-viewer (ì •ë©´ ê³ ì •) */
    #asdEyeMV{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
      background:transparent;
      /* íšŒì „/ì¤Œ ë¶ˆí•„ìš” â†’ í„°ì¹˜ ë§‰ê¸° */
      pointer-events:none;
    }

    /* ë Œì¦ˆ ì˜¤ë²„ë ˆì´ (í™ì±„ë³´ë‹¤ í¬ê²Œ, ëˆˆêº¼í’€ ì•ˆìª½ì— ë“¤ì–´ê°„ ëŠë‚Œ) */
    #asdLensImg{
      position:absolute;
      left:50%;
      top:53%;
      width:70%;
      transform:translate(-50%,-50%) rotate(20deg);
      transform-origin:50% 50%;
      opacity:.55;               /* âœ… ì•½ê°„ íˆ¬ëª… */
      mix-blend-mode: screen;    /* âœ… ë’¤ í™ì±„ ë³´ì´ê²Œ */
      filter:saturate(1.08) contrast(1.06);
      pointer-events:none;
      will-change: transform;
    }

    /* ë Œì¦ˆ ê°€ì¥ìë¦¬ í•˜ì´ë¼ì´íŠ¸ */
    #asdLensRim{
      position:absolute;
      left:50%;
      top:53%;
      width:70%;
      height:70%;
      transform:translate(-50%,-50%);
      border-radius:999px;
      pointer-events:none;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.12),
        0 18px 46px rgba(0,0,0,.22),
        inset 0 0 24px rgba(255,255,255,.10);
      opacity:.55;
      mix-blend-mode: screen;
    }

    /* ëˆˆêº¼í’€ ì•ˆìª½ìœ¼ë¡œ ë“¤ì–´ê°„ ëŠë‚Œ(ê°€ì¥ìë¦¬ ë§ˆìŠ¤í‚¹) */
    #asdMaskShade{
      position:absolute; inset:0;
      pointer-events:none;
      /* ìœ„/ì•„ë˜ ëˆˆêº¼í’€ ê·¸ë¦¼ì */
      background:
        radial-gradient(110% 70% at 50% 18%,
          rgba(0,0,0,.50) 0%,
          rgba(0,0,0,.28) 30%,
          rgba(0,0,0,0) 58%),
        radial-gradient(110% 70% at 50% 90%,
          rgba(0,0,0,.46) 0%,
          rgba(0,0,0,.22) 32%,
          rgba(0,0,0,0) 60%);
      mix-blend-mode: multiply;
      opacity:.9;
    }

    /* ê¹œë°•ì„(ëˆˆêº¼í’€) ë ˆì´ì–´ */
    #asdBlinkLid{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.62);
      transform:scaleY(0);
      transform-origin:center;
      opacity:0;
      pointer-events:none;
      will-change:transform,opacity;
      z-index:4;
    }

    /* ê¹œë°•ì„ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨, ì›í˜•, ë°˜íˆ¬ëª…) */
    #asdBlinkBtn{
      position:absolute;
      right:14px;
      bottom:14px;
      width:54px;
      height:54px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.26);
      background:rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      color:#0b1b2e;
      font-weight:900;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      cursor:pointer;
      box-shadow:0 10px 28px rgba(0,0,0,.20);
      z-index:5;
    }
    #asdBlinkBtn:active{ transform:scale(.95); }

    /* (í‘œì‹œ) í˜„ì¬ ê°ë„ */
    #asdAngleBadge{
      position:absolute;
      left:14px;
      bottom:18px;
      color:rgba(234,242,255,.88);
      font-size:12px;
      font-weight:900;
      text-shadow:0 2px 10px rgba(0,0,0,.35);
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      padding:6px 10px;
      backdrop-filter: blur(8px);
      z-index:5;
    }

    /* PVP í° ì›í˜• */
    #pvpBig{
      position:fixed;
      left:50%;
      top:49%;
      transform:translate(-50%,-50%);
      width:min(72vw, 520px);
      height:min(72vw, 520px);
      border-radius:999px;
      z-index:56;
      display:none;
      pointer-events:none;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter: blur(8px);
      overflow:hidden;
      box-shadow:0 18px 70px rgba(0,0,0,.35);
    }
    #pvpBig.show{ display:block; }
    #pvpBig img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      border-radius:999px;
      filter:saturate(1.05) contrast(1.02);
    }
    #pvpBig::after{
      content:"";
      position:absolute; inset:0;
      border-radius:999px;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
      pointer-events:none;
    }

    /* PVP í•˜ë‹¨ ì„¤ëª… */
    #pvpOverlay{
      position:fixed; left:12px; right:12px; bottom:92px; z-index:60;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 10px;
      display:none;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(10px);
    }
    #pvpOverlay.show{ display:flex; }
    #pvpOverlay img{
      width:88px;height:88px;object-fit:cover;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    #pvpText{color:#eaf2ff;font-size:12.5px;line-height:1.35;}
    #pvpTitle{font-weight:900;margin-bottom:2px;}
    #hint{opacity:.85;}

    /* ë¸”ë£¨ë¼ì´íŠ¸(55%) */
    #blueFx{
      position:fixed; inset:0; z-index:58;
      pointer-events:none;
      display:none;
    }
    #blueFx.show{ display:block; }

    .beam{
      position:absolute;
      top:46%;
      height:10px;
      filter: blur(1px);
      opacity:.95;
      transform:translateY(-50%) rotate(-10deg);
      border-radius:999px;
    }
    .beam-pass{
      left:-10%;
      width:65%;
      background:linear-gradient(90deg,
        rgba(0,200,255,0) 0%,
        rgba(0,200,255,.65) 25%,
        rgba(0,200,255,1.0) 50%,
        rgba(0,200,255,.65) 75%,
        rgba(0,200,255,0) 100%
      );
      animation: passMove 1.05s ease-in-out infinite;
    }
    @keyframes passMove{
      0%{ transform:translateY(-50%) rotate(-10deg) translateX(-4%); opacity:.70;}
      50%{ transform:translateY(-50%) rotate(-10deg) translateX(4%);  opacity:1;}
      100%{transform:translateY(-50%) rotate(-10deg) translateX(-4%); opacity:.70;}
    }

    .beam-bounce{
      left:44%;
      width:52%;
      top:44%;
      transform:translateY(-50%) rotate(170deg);
      background:linear-gradient(90deg,
        rgba(0,200,255,0) 0%,
        rgba(0,200,255,.45) 25%,
        rgba(0,200,255,.85) 55%,
        rgba(0,200,255,.45) 80%,
        rgba(0,200,255,0) 100%
      );
      animation: bounceMove 1.05s ease-in-out infinite;
      opacity:.75;
    }
    @keyframes bounceMove{
      0%{ transform:translateY(-50%) rotate(170deg) translateX(-3%); opacity:.55;}
      50%{ transform:translateY(-50%) rotate(170deg) translateX(3%);  opacity:.85;}
      100%{transform:translateY(-50%) rotate(170deg) translateX(-3%); opacity:.55;}
    }

    #blockBadge{
      position:fixed; left:12px; right:12px; bottom:160px; z-index:70;
      display:none;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      color:#eaf2ff;
      font-weight:900;
      backdrop-filter: blur(10px);
      text-align:center;
    }
    #blockBadge.show{ display:block; }
    #blockBadge span{ color:rgba(0,255,140,.95); }

    /* ë‘ê»˜ ê·¸ë˜í”„(ê°€ë¡œí˜•) */
    #thicknessBar{
      position:fixed;
      left:12px;
      right:12px;
      bottom:92px;
      z-index:67;
      display:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      padding:10px 12px 12px;
      box-sizing:border-box;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
    }
    #thicknessBar.show{ display:block; }

    #thHeader{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      margin-bottom:8px;
    }
    #thTitle{
      color:#eaf2ff;
      font-weight:900;
      font-size:12.5px;
      letter-spacing:.2px;
      opacity:.95;
    }
    #thUnit{
      color:rgba(234,242,255,.70);
      font-size:11px;
      font-weight:700;
      letter-spacing:.1px;
    }

    #gradRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tickLabel{
      width:46px;
      text-align:right;
      color:rgba(234,242,255,.78);
      font-size:11px;
      font-weight:700;
      letter-spacing:.1px;
      flex:0 0 auto;
    }

    #gradWrap{
      position:relative;
      flex:1 1 auto;
      height:14px;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      box-shadow: inset 0 0 12px rgba(0,0,0,.35);
    }

    #grad{
      position:absolute; inset:0;
      background:linear-gradient(90deg,
        rgba(140,  0,255,1) 0%,
        rgba(  0, 90,255,1) 17%,
        rgba(  0,200,255,1) 32%,
        rgba(  0,255,150,1) 48%,
        rgba(150,255,  0,1) 64%,
        rgba(255,220,  0,1) 78%,
        rgba(255,120,  0,1) 90%,
        rgba(255, 50, 50,1) 100%
      );
      opacity:.92;
      filter:saturate(1.05) contrast(1.05);
    }

    #gradShine{
      position:absolute; inset:0;
      background:linear-gradient(180deg,
        rgba(255,255,255,.22) 0%,
        rgba(255,255,255,0) 55%,
        rgba(0,0,0,.18) 100%
      );
      mix-blend-mode: overlay;
      opacity:.55;
      pointer-events:none;
    }

    .mark{
      position:absolute;
      top:-6px;
      width:1px;
      height:26px;
      background:rgba(255,255,255,.18);
    }
    .mark strong{
      position:absolute;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      font-size:10px;
      color:rgba(234,242,255,.70);
      font-weight:700;
      white-space:nowrap;
    }
    .m0{ left:0%; }
    .m25{ left:25%; }
    .m50{ left:50%; }
    .m75{ left:75%; }
    .m100{ left:100%; }

    #thHint{ display:none; }
  </style>
</head>

<body>
  <!-- âœ… ë¯¸ì…˜ ì¹´ë“œê°€ ê¸°ëŠ¥ ë²„íŠ¼ ì—­í•  -->
  <div id="missionBar">
    <div id="missionASD" class="missionCard" role="button" tabindex="0" aria-label="ASD ê¸°ìˆ  ë³´ê¸°">
      <div class="missionNo">01</div>
      <div class="missionTitle">ASD ê¸°ìˆ </div>
      <div class="missionDesc">ì¹´ë“œë¥¼ ëˆŒëŸ¬ í™•ì¸</div>
    </div>
    <div id="missionPVP" class="missionCard" role="button" tabindex="0" aria-label="PVP ë³´ê¸°">
      <div class="missionNo">02</div>
      <div class="missionTitle">ëˆˆë¬¼ ì•ˆì •í™”</div>
      <div class="missionDesc">ì¹´ë“œë¥¼ ëˆŒëŸ¬ í™•ì¸</div>
    </div>
    <div id="missionBlue" class="missionCard" role="button" tabindex="0" aria-label="ì˜µí‹°ë¸”ë£¨ ë³´ê¸°">
      <div class="missionNo">03</div>
      <div class="missionTitle">ì˜µí‹°ë¸”ë£¨ ê¸°ìˆ </div>
      <div class="missionDesc">ì¹´ë“œë¥¼ ëˆŒëŸ¬ í™•ì¸</div>
    </div>
  </div>

  <!-- ë¸”ë£¨ë¼ì´íŠ¸ ì´í™íŠ¸ -->
  <div id="blueFx">
    <div class="beam beam-pass"></div>
    <div class="beam beam-bounce"></div>
  </div>
  <div id="blockBadge">ë¸”ë£¨ë¼ì´íŠ¸ <span>55%</span> ì°¨ë‹¨ ì—°ì¶œ</div>

  <!-- ë‘ê»˜ ê·¸ë˜í”„ -->
  <div id="thicknessBar" aria-hidden="true">
    <div id="thHeader">
      <div id="thTitle">ë‘ê»˜</div>
      <div id="thUnit">mm</div>
    </div>

    <div id="gradRow">
      <div class="tickLabel">ì–†ìŒ_0.0</div>
      <div id="gradWrap">
        <div id="grad"></div>
        <div id="gradShine"></div>

        <div class="mark m0"><strong>0.0</strong></div>
        <div class="mark m25"><strong>0.1</strong></div>
        <div class="mark m50"><strong>0.2</strong></div>
        <div class="mark m75"><strong>0.3</strong></div>
        <div class="mark m100"><strong>0.4</strong></div>
      </div>
      <div class="tickLabel" style="text-align:left;width:46px;">0.4_ë‘ê»</div>
    </div>
    <div id="thHint"></div>
  </div>

  <!-- PVP í° ì›í˜• -->
  <div id="pvpBig">
    <img id="pvpBigImg" src="PVP.gif" alt="PVP Big" onerror="this.onerror=null; this.src='PVP.jpeg';">
  </div>


  <!-- PVP í•˜ë‹¨ ì„¤ëª… -->
  <div id="pvpOverlay">
    <img id="pvpThumb" src="PVP.png" alt="PVP" onerror="this.onerror=null; this.src='PVP.jpeg';">
    <div id="pvpText">
      <div id="pvpTitle">PVP ìŠµìœ¤ ì¸ì</div>
      <div id="hint">ë Œì¦ˆ ë‚´ PVP ìŠµìœ¤ì¸ìê°€ ìˆ˜ë¶„ì„ ëŒì–´ë‹¹ê²¨ ë” ì˜¤ë«ë™ì•ˆ ëˆˆë¬¼ë§‰ ìœ ì§€í•˜ì—¬ ê±´ì¡°ê° ê°ì†Œ.</div>
    </div>
  </div>

  <!-- ASD ì˜¤ë²„ë ˆì´ -->
  <div id="asdOverlay" aria-hidden="true">
    <div id="asdCard">
      <button id="asdClose" type="button" aria-label="ë‹«ê¸°">âœ•</button>

      <!-- âœ… ASD êµ¬í˜„: eye_animation.glb + lens overlay -->
      <div id="asdScene">
        <model-viewer
          id="asdEyeMV"
          src="eye_animation.glb"
          camera-orbit="0deg 90deg 0.78m"
          camera-target="0m 0.02m 0m"
          exposure="1.25"
          tone-mapping="aces"
          environment-image="neutral"
          shadow-intensity="0"
          interaction-prompt="none"
          style="display:block;">
        </model-viewer>

        <div id="asdLensRim" aria-hidden="true"></div>
        <img id="asdLensImg" src="lens.png" alt="Lens overlay"
             onerror="this.style.display='none'; document.getElementById('asdHint').textContent='lens.png / lens2.png íŒŒì¼ì„ ê°™ì€ í´ë”ì— ë„£ì–´ì£¼ì„¸ìš”.';">
        <div id="asdMaskShade" aria-hidden="true"></div>

        <div id="asdBlinkLid" aria-hidden="true"></div>

        <div id="asdAngleBadge">20Â°</div>
        <button id="asdBlinkBtn" type="button" aria-label="ëˆˆ ê¹œë°•">ê¹œë°•</button>
      </div>

      <div id="asdHint">ASD ì°¸ê³  ì´ë¯¸ì§€</div>
    </div>
  </div>

  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>

  <model-viewer
    id="mv"
    src="lens_clear.glb"
    camera-controls
    camera-orbit="0deg 100deg 2.6m"
    camera-target="0m 0.015m 0m"
    touch-action="pan-y"
    exposure="1.35"
    tone-mapping="aces"
    environment-image="neutral"
    shadow-intensity="0"
    style="display:block;">
  </model-viewer>

  <div id="bottomBtns">
    <button id="btnReset" title="ì²˜ìŒ ìœ„ì¹˜ë¡œ">â†º</button>
    <button id="modeLens" class="btn primary">íˆ¬ëª… ë Œì¦ˆ ëª¨ë“œ</button>
    <button id="modeHeat" class="btn">ë Œì¦ˆ ë‘ê»˜ MAP</button>
  </div>

  <script>
    const mv = document.getElementById('mv');

    // âœ… ìƒë‹¨ ë¯¸ì…˜(=ê¸°ëŠ¥ ë²„íŠ¼)
    const missionASD  = document.getElementById('missionASD');
    const missionPVP  = document.getElementById('missionPVP');
    const missionBlue = document.getElementById('missionBlue');

    const modeLens = document.getElementById('modeLens');
    const modeHeat = document.getElementById('modeHeat');

    const btnReset = document.getElementById('btnReset');

    const asdOverlay = document.getElementById('asdOverlay');
    const asdClose   = document.getElementById('asdClose');

    const pvpOverlay = document.getElementById('pvpOverlay');
    const pvpBig     = document.getElementById('pvpBig');

    const blueFx = document.getElementById('blueFx');
    const blockBadge = document.getElementById('blockBadge');

    const thicknessBar = document.getElementById('thicknessBar');

    /* âœ… ASD ìš”ì†Œ */
    const asdEyeMV = document.getElementById('asdEyeMV');
    const asdLensImg = document.getElementById('asdLensImg');
    const asdBlinkBtn = document.getElementById('asdBlinkBtn');
    const asdBlinkLid = document.getElementById('asdBlinkLid');
    const asdAngleBadge = document.getElementById('asdAngleBadge');
    const asdLensRim = document.getElementById('asdLensRim');

    let currentMode = 'lens'; // 'lens' | 'heat'
    let blueOn = false;
    let pvpOn = false;

    // íˆ¬ëª…/íˆíŠ¸ë§µ ì „í™˜ ì‹œì—ë„ ì¹´ë©”ë¼(orbit+target) ì—°ë™
    let lastOrbit = null;
    let lastTarget = null;

    // ë””í´íŠ¸(ì²˜ìŒ ìƒíƒœ)
    let defaultOrbit = null;
    let defaultTarget = null;

    // ë¸”ë£¨ ON í•  ë•Œ ê°•ì œ ê°ë„
    const BLUE_ORBIT_STR  = '20deg 88deg 2.75m';
    const BLUE_TARGET_STR = '0m 0.010m 0m';
    let orbitBeforeBlue = null;
    let targetBeforeBlue = null;

    // ë¸”ë£¨ê·¸ë¦° í‹´íŠ¸
    const BLUEGREEN_TINT = [0.55, 1.08, 0.72, 0.45];

    // ì›ë³¸ ìƒ‰ ë°±ì—…
    let allMaterialBackup = null;

    /* âœ…âœ… ASD ë¡œì§ (ìš”ì²­ì‚¬í•­ ë°˜ì˜)
       - ì‹œì‘: +20deg (ìš°ì¸¡ 20ë„)
       - 4ë²ˆ í´ë¦­: 20â†’15â†’10â†’5â†’0 (ì›ìœ„ì¹˜)
       - ê·¸ ì´í›„ í´ë¦­: ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ë¯¸ë„ëŸ¬ì¡Œë‹¤ê°€ ì›ìœ„ì¹˜ ë°˜ë³µ(ê°ë„ 0 ìœ ì§€)
       - ë‘ê»˜ë§µ ëª¨ë“œì—ì„œ ASD í´ë¦­ ì‹œ lens2.png ì‚¬ìš©
    */
    let asdAngle = 20;
    const ASD_STEP = 5;
    const ASD_START = 20;

    function pickASDLensSrc(){
      // âœ… ë‘ê»˜ë§µ ìƒíƒœë©´ lens2.png (ìš”ì²­)
      return (currentMode === 'heat') ? 'lens2.png' : 'lens.png';
    }

    function setASDLensSrc(){
      if(!asdLensImg) return;
      const src = pickASDLensSrc();
      asdLensImg.src = src + '?v=' + Date.now();
      // rim ìœ„ì¹˜/í¬ê¸° ë™ê¸°í™”(ê³ ì •ê°’ì´ë¼ ë³„ë„ ê³„ì‚° ì—†ìŒ)
    }

    function renderASDLensTransform(extraX=0){
      if(!asdLensImg) return;
      // lens: í™ì±„ë³´ë‹¤ í¬ê²Œ + ëˆˆêº¼í’€ì— ì‚´ì§ ë“¤ì–´ê°„ ëŠë‚Œ (CSS top/widthë¡œ ê¸°ë³¸ ì„¸íŒ…)
      asdLensImg.style.transform = `translate(calc(-50% + ${extraX}px), -50%) rotate(${asdAngle}deg)`;
      if(asdAngleBadge) asdAngleBadge.textContent = `${asdAngle}Â°`;
      if(asdLensRim){
        // rimì€ íšŒì „ ì—†ì´ ê·¸ëŒ€ë¡œ
        // (ìš”ì²­) ì„ì˜ ë³€ê²½ ì‹«ì–´í•´ì„œ, ì—¬ê¸°ì„œ rim ë³€í˜•ì€ í•˜ì§€ ì•ŠìŒ
      }
    }

    function resetASDState(){
      asdAngle = ASD_START;
      renderASDLensTransform(0);
      // ë²„íŠ¼ì€ ê³„ì† í´ë¦­ ê°€ëŠ¥ (ìš”ì²­: 0 ì´í›„ë„ ì‘ë™í•´ì•¼í•¨)
    }

    function playBlinkLid(){
      if(!asdBlinkLid) return;
      asdBlinkLid.style.transition = 'none';
      asdBlinkLid.style.transform = 'scaleY(0)';
      asdBlinkLid.style.opacity = '0';
      requestAnimationFrame(()=>{
        asdBlinkLid.style.transition = 'transform 120ms ease, opacity 120ms ease';
        asdBlinkLid.style.transform = 'scaleY(1)';
        asdBlinkLid.style.opacity = '0.88';
        setTimeout(()=>{
          asdBlinkLid.style.transition = 'transform 150ms ease, opacity 150ms ease';
          asdBlinkLid.style.transform = 'scaleY(0)';
          asdBlinkLid.style.opacity = '0';
        }, 120);
      });
    }

    function slipLeftAndBack(){
      // âœ… ê°ë„ 0 ìœ ì§€ + ì™¼ìª½ìœ¼ë¡œ ì‚´ì§ ë¯¸ë„ëŸ¬ì¡Œë‹¤ê°€ ì›ìœ„ì¹˜
      renderASDLensTransform(0);
      // ë¯¸ë„ëŸ¬ì§ ì• ë‹ˆë©”ì´ì…˜ì€ transformì„ ì ê¹ ë°”ê¿”ì„œ êµ¬í˜„
      renderASDLensTransform(0);
      // ì™¼ìª½ìœ¼ë¡œ
      requestAnimationFrame(()=>{
        if(!asdLensImg) return;
        asdLensImg.style.transition = 'transform 120ms ease';
        renderASDLensTransform(-10);
        setTimeout(()=>{
          if(!asdLensImg) return;
          asdLensImg.style.transition = 'transform 160ms ease';
          renderASDLensTransform(0);
          setTimeout(()=>{
            if(!asdLensImg) return;
            asdLensImg.style.transition = '';
          }, 170);
        }, 120);
      });
    }

    function handleASDBlink(){
      playBlinkLid();

      if(asdAngle > 0){
        asdAngle = Math.max(0, asdAngle - ASD_STEP);
        // ê°ë„ ì´ë™ì€ ë¶€ë“œëŸ½ê²Œ
        if(asdLensImg){
          asdLensImg.style.transition = 'transform 160ms ease';
          renderASDLensTransform(0);
          setTimeout(()=>{ if(asdLensImg) asdLensImg.style.transition = ''; }, 170);
        }else{
          renderASDLensTransform(0);
        }
      }else{
        // 0 ì´í›„ëŠ” ë¯¸ë„ëŸ¬ì§ ë°˜ë³µ
        slipLeftAndBack();
      }
    }

    if(asdBlinkBtn){
      asdBlinkBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        handleASDBlink();
      });
    }

    function getOrbitSafe(){
      try{ return mv.getCameraOrbit(); }catch(e){ return null; }
    }
    function getTargetSafe(){
      try{ return mv.getCameraTarget(); }catch(e){ return null; }
    }

    function applyOrbit(orbit){
      if(!orbit) return;
      try{ mv.cameraOrbit = `${orbit.theta}rad ${orbit.phi}rad ${orbit.radius}m`; }catch(e){}
    }
    function applyTarget(target){
      if(!target) return;
      try{ mv.cameraTarget = `${target.x}m ${target.y}m ${target.z}m`; }catch(e){}
    }

    function applyOrbitStr(s){
      try{ mv.cameraOrbit = s; }catch(e){}
    }
    function applyTargetStr(s){
      try{ mv.cameraTarget = s; }catch(e){}
    }

    function resetCameraToDefault(){
      if(!defaultOrbit || !defaultTarget) return;
      applyTarget(defaultTarget);
      applyOrbit(defaultOrbit);
      setTimeout(()=>{
        applyTarget(defaultTarget);
        applyOrbit(defaultOrbit);
      }, 120);
    }

    function showBlueFx(show){
      blueFx.classList.toggle('show', show);
      blockBadge.classList.toggle('show', show);
    }

    function showPVP(show){
      pvpOverlay.classList.toggle('show', show);
      pvpBig.classList.toggle('show', show);
    }

    function showThickness(show){
      thicknessBar.classList.toggle('show', show);
      thicknessBar.setAttribute('aria-hidden', show ? 'false' : 'true');
    }

    // âœ… PVP í™•ëŒ€ ë¹„ìœ¨
    const PVP_ZOOM_FACTOR = 0.76;

    function zoomInForPVP(){
      try{
        const orbit = getOrbitSafe();
        if(!orbit) return;
        const targetRadius = orbit.radius * PVP_ZOOM_FACTOR;
        mv.cameraOrbit = `${orbit.theta}rad ${orbit.phi}rad ${targetRadius}m`;
      }catch(e){}
    }

    function tuneClearLensMaterials(){
      try{
        const model = mv.model;
        if(!model || !model.materials) return;

        model.materials.forEach(mat=>{
          const pbr = mat.pbrMetallicRoughness;
          if(!pbr) return;

          const base = pbr.baseColorFactor ? [...pbr.baseColorFactor] : [1,1,1,1];
          base[3] = Math.max(base[3], 0.45);
          pbr.setBaseColorFactor(base);

          try{ pbr.setRoughnessFactor(0.28); }catch(e){}
          try{ pbr.setMetallicFactor(0.0); }catch(e){}

          if(mat.extensions && mat.extensions.KHR_materials_transmission){
            mat.extensions.KHR_materials_transmission.transmissionFactor = 0.86;
          }

          try{
            if(mat.emissiveFactor){ mat.emissiveFactor = [0.04, 0.06, 0.07]; }
          }catch(e){}

          try{ if(mat.setAlphaMode) mat.setAlphaMode('BLEND'); }catch(e){}
        });
      }catch(e){}
    }

    function backupOriginalColors(){
      try{
        const model = mv.model;
        if(!model || !model.materials) return;
        allMaterialBackup = model.materials.map(mat=>{
          const pbr = mat.pbrMetallicRoughness;
          const base = (pbr && pbr.baseColorFactor) ? [...pbr.baseColorFactor] : [1,1,1,1];
          return base;
        });
      }catch(e){
        allMaterialBackup = null;
      }
    }

    function restoreOriginalColors(){
      try{
        const model = mv.model;
        if(!model || !model.materials || !allMaterialBackup) return;
        model.materials.forEach((mat, idx)=>{
          const pbr = mat.pbrMetallicRoughness;
          if(!pbr) return;
          const base = allMaterialBackup[idx] ? [...allMaterialBackup[idx]] : [1,1,1,1];
          base[3] = Math.max(base[3], 0.45);
          pbr.setBaseColorFactor(base);
        });
      }catch(e){}
    }

    function applyTint(){
      try{
        const model = mv.model;
        if(!model || !model.materials) return;
        model.materials.forEach((mat, idx)=>{
          const pbr = mat.pbrMetallicRoughness;
          if(!pbr) return;
          const cur = pbr.baseColorFactor ? [...pbr.baseColorFactor] : (allMaterialBackup?.[idx] ? [...allMaterialBackup[idx]] : [1,1,1,1]);
          const a = Math.max(cur[3] ?? 0.45, 0.45);
          pbr.setBaseColorFactor([BLUEGREEN_TINT[0], BLUEGREEN_TINT[1], BLUEGREEN_TINT[2], a]);
        });
      }catch(e){}
    }

    // âœ… ìƒë‹¨ ì¹´ë“œ ON/OFF UI ë™ê¸°í™”
    function syncMissionUI(){
      missionASD.classList.toggle('on', asdOverlay.classList.contains('show'));
      missionPVP.classList.toggle('on', pvpOn);
      missionBlue.classList.toggle('on', blueOn);
    }

    function closeASD(){
      asdOverlay.classList.remove('show');
      asdOverlay.setAttribute('aria-hidden','true');
      resetCameraToDefault();
      syncMissionUI();
    }

    function setModeButtons(){
      modeLens.classList.toggle('primary', currentMode === 'lens');
      modeHeat.classList.toggle('primary', currentMode === 'heat');
    }

    function forceBlueOff(){
      if(!blueOn) return;
      blueOn = false;
      showBlueFx(false);
      restoreOriginalColors();

      if(orbitBeforeBlue && targetBeforeBlue){
        applyTarget(targetBeforeBlue);
        applyOrbit(orbitBeforeBlue);
        setTimeout(()=>{
          applyTarget(targetBeforeBlue);
          applyOrbit(orbitBeforeBlue);
        }, 120);
      }
      orbitBeforeBlue = null;
      targetBeforeBlue = null;
      syncMissionUI();
    }

    function forcePVPOff(){
      if(!pvpOn) return;
      pvpOn = false;
      showPVP(false);
      syncMissionUI();
    }

    function openASD(){
      // ASD ì¼œë©´ ë‹¤ë¥¸ ê¸°ëŠ¥ ê°•ì œ OFF + ë””í´íŠ¸
      if(blueOn) forceBlueOff();
      if(pvpOn)  forcePVPOff();
      resetCameraToDefault();

      // âœ… ASD: í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë Œì¦ˆ ì´ë¯¸ì§€ ì„ íƒ(lens.png / lens2.png)
      setASDLensSrc();
      // âœ… ASD: ê°ë„ ì´ˆê¸°í™”(20ë„) + ì •ë©´ ê³ ì • ìƒíƒœë¡œ ì‹œì‘
      resetASDState();

      // eye glb ì¬ë¡œë”©(í•„ìš” ì‹œ)
      if(asdEyeMV){
        asdEyeMV.src = 'eye_animation.glb' + '?v=' + Date.now();
      }

      asdOverlay.classList.add('show');
      asdOverlay.setAttribute('aria-hidden','false');
      syncMissionUI();
    }

    function setModel(file, mode){
      return new Promise((resolve)=>{
        lastOrbit = getOrbitSafe();
        lastTarget = getTargetSafe();

        currentMode = mode;

        // ëª¨ë“œ ì „í™˜í•˜ë©´ PVP/ë¸”ë£¨ ë‹«ê¸°
        forcePVPOff();
        forceBlueOff();

        showThickness(mode === 'heat');
        setModeButtons();

        const onLoadOnce = ()=>{
          mv.removeEventListener('load', onLoadOnce);
          resolve();
        };
        mv.addEventListener('load', onLoadOnce, { once:true });

        mv.src = file + '?v=' + Date.now();
      });
    }

    mv.addEventListener('load', ()=>{
      if(!defaultOrbit) defaultOrbit = getOrbitSafe();
      if(!defaultTarget) defaultTarget = getTargetSafe();

      if(lastTarget) applyTarget(lastTarget);
      if(lastOrbit)  applyOrbit(lastOrbit);

      setTimeout(()=>{
        if(lastTarget) applyTarget(lastTarget);
        if(lastOrbit)  applyOrbit(lastOrbit);
      }, 120);

      if(currentMode === 'lens'){
        tuneClearLensMaterials();
        backupOriginalColors();
      }

      setModeButtons();
      syncMissionUI();
    });

    /* âœ… ASD (ë¯¸ì…˜ 01 ì¹´ë“œ í´ë¦­) */
    function toggleASD(){
      if(asdOverlay.classList.contains('show')) closeASD();
      else openASD();
    }
    missionASD.addEventListener('click', toggleASD);
    missionASD.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') toggleASD(); });

    asdClose.addEventListener('click', closeASD);
    asdOverlay.addEventListener('click', (e)=>{ if(e.target === asdOverlay) closeASD(); });

    /* âœ… PVP (ë¯¸ì…˜ 02 ì¹´ë“œ í´ë¦­) */
    async function togglePVP(){
      if(currentMode === 'heat'){
        await setModel('lens_clear.glb', 'lens');
      }
      if(currentMode !== 'lens') return;

      if(!pvpOn){
        if(blueOn) forceBlueOff();
      }

      pvpOn = !pvpOn;

      if(pvpOn){
        resetCameraToDefault();
        setTimeout(()=>{
          zoomInForPVP();
          showPVP(true);
          syncMissionUI();
        }, 140);
      }else{
        showPVP(false);
        resetCameraToDefault();
        syncMissionUI();
      }
    }
    missionPVP.addEventListener('click', togglePVP);
    missionPVP.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') togglePVP(); });

    /* âœ… ë¸”ë£¨ (ë¯¸ì…˜ 03 ì¹´ë“œ í´ë¦­) */
    async function toggleBlue(){
      if(currentMode === 'heat'){
        await setModel('lens_clear.glb', 'lens');
      }
      if(currentMode !== 'lens') return;

      if(!blueOn){
        if(pvpOn) forcePVPOff();
      }

      blueOn = !blueOn;

      if(blueOn){
        orbitBeforeBlue = getOrbitSafe();
        targetBeforeBlue = getTargetSafe();

        applyOrbitStr(BLUE_ORBIT_STR);
        applyTargetStr(BLUE_TARGET_STR);
        setTimeout(()=>{
          applyOrbitStr(BLUE_ORBIT_STR);
          applyTargetStr(BLUE_TARGET_STR);
        }, 120);

        if(!allMaterialBackup) backupOriginalColors();
        applyTint();
        showBlueFx(true);
        syncMissionUI();
      }else{
        showBlueFx(false);
        restoreOriginalColors();

        if(orbitBeforeBlue && targetBeforeBlue){
          applyTarget(targetBeforeBlue);
          applyOrbit(orbitBeforeBlue);
          setTimeout(()=>{
            applyTarget(targetBeforeBlue);
            applyOrbit(orbitBeforeBlue);
          }, 120);
        }
        orbitBeforeBlue = null;
        targetBeforeBlue = null;

        resetCameraToDefault();
        syncMissionUI();
      }
    }
    missionBlue.addEventListener('click', toggleBlue);
    missionBlue.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') toggleBlue(); });

    /* ë°±(â†º) ë²„íŠ¼ */
    btnReset.addEventListener('click', ()=>{
      resetCameraToDefault();
    });

    /* ëª¨ë“œ */
    modeLens.addEventListener('click', ()=> setModel('lens_clear.glb', 'lens'));
    modeHeat.addEventListener('click', ()=> setModel('lens_heatmap.glb', 'heat'));

    // ì´ˆê¸°
    setModel('lens_clear.glb', 'lens');
  </script>
</body>
</html>


