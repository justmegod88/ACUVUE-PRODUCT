<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ACUVUE TORIC Web 3D MVP</title>
  <style>
    :root{
      --bg1:#081625;
      --bg2:#0a1f33;
      --panel:rgba(10,24,40,.72);
      --bd:rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,.72);
      --accent:#2fd1ff;
      --green:#20c65a;
      --green2:#12a34a;
      --danger:#ff3b30;
      --yellow:#ffd26a;
    }
    html,body{height:100%; margin:0; font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial; color:var(--text);
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    #app{position:fixed; inset:0; overflow:hidden;}
    canvas{position:absolute; inset:0; width:100%; height:100%; display:block;}

    .topbar{
      position:absolute; left:0; right:0; top:0;
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(5,12,20,.92), rgba(5,12,20,.40));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
      z-index:5;
    }
    .top-left{font-weight:800; font-size:14px;}
    .btn-close{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      font-size:12px;
    }

    .product-pill{
      position:absolute; left:50%; transform:translateX(-50%);
      top:62px; z-index:6;
      max-width:86%;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
      font-size:14px;
      text-align:center;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .tag{
      display:inline-block;
      margin-left:8px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      background:rgba(47,209,255,.16);
      border:1px solid rgba(47,209,255,.35);
      color:var(--text);
      vertical-align:middle;
    }

    .status{
      position:absolute;
      left:14px; right:70px;
      top:110px;
      z-index:6;
      font-size:12px;
      color:rgba(234,242,255,.78);
      text-shadow: 0 2px 8px rgba(0,0,0,.35);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .status b{color:var(--yellow);}

    .right-stack{
      position:absolute;
      right:14px;
      top:120px;
      z-index:6;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .iconbtn{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      display:grid;
      place-items:center;
      font-weight:900;
      font-size:12px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn.on{
      background:rgba(47,209,255,.18);
      border-color:rgba(47,209,255,.45);
    }

    .bottom{
      position:absolute; left:0; right:0; bottom:0;
      padding:12px 14px 16px;
      z-index:6;
      background:linear-gradient(0deg, rgba(5,12,20,.94), rgba(5,12,20,.22));
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.06);
    }
    .tabs{
      display:flex; justify-content:center; gap:10px; margin-bottom:10px;
    }
    .tab{
      width:44px; height:44px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      display:grid; place-items:center;
      font-weight:900; font-size:12px;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.on{background:rgba(255,255,255,.16);}
    .cta{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 14px;
      color:#062012;
      background:linear-gradient(180deg,var(--green),var(--green2));
      font-weight:1000;
      font-size:14px;
      -webkit-tap-highlight-color: transparent;
    }
    .sub{
      margin-top:8px;
      text-align:center;
      font-size:12px;
      color:rgba(234,242,255,.72);
    }

    .sheet{
      position:absolute;
      left:14px; right:14px;
      bottom:92px;
      z-index:7;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:12px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
    }
    .sheet.show{display:block;}
    .sheet h3{margin:0 0 6px 0; font-size:14px;}
    .sheet p{margin:0; font-size:13px; color:var(--muted); line-height:1.35;}
    .row{display:flex; gap:8px; margin-top:10px;}
    .smallbtn{
      flex:1;
      border-radius:12px;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:900;
      font-size:13px;
      -webkit-tap-highlight-color: transparent;
    }
    .smallbtn.primary{
      background:rgba(255,59,48,.18);
      border-color:rgba(255,59,48,.45);
    }

    .modal{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:10;
      padding:18px;
    }
    .modal.show{display:block;}
    .modalcard{
      position:absolute;
      left:18px; right:18px;
      top:50%; transform:translateY(-50%);
      background:rgba(10,24,40,.94);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:14px;
    }
    .qtitle{font-weight:1000; margin:0 0 10px 0;}
    .qnum{color:rgba(234,242,255,.78); font-size:12px; margin-bottom:6px;}
    .opt{
      width:100%;
      text-align:left;
      margin-top:8px;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:800;
      -webkit-tap-highlight-color: transparent;
    }
    .opt.correct{border-color:rgba(32,198,90,.7); background:rgba(32,198,90,.14);}
    .opt.wrong{border-color:rgba(255,59,48,.7); background:rgba(255,59,48,.14);}
    .modalfoot{display:flex; gap:10px; margin-top:12px;}
    .modalfoot button{
      flex:1;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:1000;
    }
  </style>
</head>
<body>
<div id="app">
  <canvas id="c"></canvas>

  <div class="topbar">
    <div class="top-left">결과</div>
    <div class="top-right">
      <button class="btn-close" id="btnClose">닫기</button>
    </div>
  </div>

  <div class="product-pill" id="productPill">아큐브 오아시스 원데이 난시</div>
  <div class="status" id="statusText">로딩중… (렌즈는 코드로 생성, 눈은 GLB 로딩)</div>

  <div class="right-stack">
    <div class="iconbtn" id="btnRotate" title="360">360</div>
    <div class="iconbtn on" id="btnASD" title="ASD">ASD</div>
    <div class="iconbtn" id="btnPVP" title="PVP">PVP</div>
    <div class="iconbtn" id="btnBL" title="BL">BL</div>
  </div>

  <div class="sheet" id="sheet">
    <h3 id="sheetTitle">ASD 난시 디자인</h3>
    <p id="sheetBody">순목(눈깜박임) 시 눈꺼풀과 렌즈의 상호작용으로 난시 축이 빠르게 제자리로 안정됩니다.</p>
    <div class="row" id="sheetRow">
      <button class="smallbtn primary" id="btnBlink">순목(눈깜박임) 버튼</button>
      <button class="smallbtn" id="btnBeforeAfter">Before / After</button>
    </div>
  </div>

  <div class="bottom">
    <div class="tabs">
      <div class="tab on" id="tab1">1D</div>
      <div class="tab" id="tab2">MAX</div>
      <div class="tab" id="tabQuiz">Q</div>
    </div>
    <button class="cta" id="ctaBtn">순목(눈깜박임)</button>
    <div class="sub" id="ctaSub">버튼 클릭 시 눈이 깜박이며, 렌즈 축이 안정화되는 연출을 확인합니다.</div>
  </div>

  <div class="modal" id="modal">
    <div class="modalcard">
      <div class="qnum" id="qnum">퀴즈 1/2</div>
      <h3 class="qtitle" id="qtitle">Q. ASD 디자인에서 ‘순목’이 하는 역할은?</h3>
      <button class="opt" data-idx="0" id="opt0">렌즈를 건조하게 만든다</button>
      <button class="opt" data-idx="1" id="opt1">축 안정화를 돕는다</button>
      <button class="opt" data-idx="2" id="opt2">블루라이트를 차단한다</button>
      <div class="modalfoot">
        <button id="btnModalClose">닫기</button>
        <button id="btnNext">다음</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

  // ---------- DOM ----------
  const productPill = document.getElementById('productPill');
  const statusText  = document.getElementById('statusText');

  const btnRotate = document.getElementById('btnRotate');
  const btnASD = document.getElementById('btnASD');
  const btnPVP = document.getElementById('btnPVP');
  const btnBL  = document.getElementById('btnBL');

  const tab1 = document.getElementById('tab1');
  const tab2 = document.getElementById('tab2');
  const tabQuiz = document.getElementById('tabQuiz');

  const sheet = document.getElementById('sheet');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetBody  = document.getElementById('sheetBody');
  const sheetRow   = document.getElementById('sheetRow');
  const btnBlink   = document.getElementById('btnBlink');
  const btnBeforeAfter = document.getElementById('btnBeforeAfter');

  const ctaBtn = document.getElementById('ctaBtn');
  const ctaSub = document.getElementById('ctaSub');

  const modal = document.getElementById('modal');
  const qnum = document.getElementById('qnum');
  const qtitle = document.getElementById('qtitle');
  const opt0 = document.getElementById('opt0');
  const opt1 = document.getElementById('opt1');
  const opt2 = document.getElementById('opt2');
  const btnModalClose = document.getElementById('btnModalClose');
  const btnNext = document.getElementById('btnNext');

  document.getElementById('btnClose').addEventListener('click', ()=> alert('닫기(데모)'));

  // ---------- Three.js ----------
  const canvas = document.getElementById('c');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.outputColorSpace = THREE.SRGBColorSpace;

  const scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x071322, 5, 18);

  const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
  camera.position.set(0, 0.2, 5.2);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.enablePan = false;
  controls.minDistance = 2.6;
  controls.maxDistance = 7.5;
  controls.rotateSpeed = 0.9;
  controls.target.set(0, 0, 0);
  controls.update();

  // lights
  scene.add(new THREE.HemisphereLight(0xcfe7ff, 0x0a1b2f, 0.9));
  const key = new THREE.DirectionalLight(0xffffff, 1.0);
  key.position.set(3, 2, 3);
  scene.add(key);
  const rim = new THREE.DirectionalLight(0x5aa6ff, 0.55);
  rim.position.set(-3, 1, -2);
  scene.add(rim);

  // root groups
  const root = new THREE.Group();
  scene.add(root);

  const eyeGroup = new THREE.Group();
  root.add(eyeGroup);

  const lensGroup = new THREE.Group();
  root.add(lensGroup);

  // ---------- ALWAYS-VISIBLE fallback helper (so you never see "blank") ----------
  // tiny center dot
  const dot = new THREE.Mesh(
    new THREE.SphereGeometry(0.03, 16, 16),
    new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.6 })
  );
  root.add(dot);

  // ---------- TEMP Lens (generated) - MUST BE VISIBLE ----------
  const lensGeo = new THREE.CircleGeometry(1.05, 96);
  const lensMat = new THREE.MeshPhysicalMaterial({
    color: 0x86ddff,
    transparent: true,
    opacity: 0.18,
    roughness: 0.14,
    transmission: 0.95,
    thickness: 0.12,
    ior: 1.33,
    clearcoat: 0.7,
    clearcoatRoughness: 0.12,
    side: THREE.DoubleSide,    // ★ 핵심: 양면 렌더링
    depthWrite: false          // ★ 투명 안정화
  });
  const lens = new THREE.Mesh(lensGeo, lensMat);
  lens.position.set(0, 0, 0.6);     // ★ 너무 앞(1.35)로 두면 안 보일 수 있음
  lens.renderOrder = 2;
  lensGroup.add(lens);

  // axis line
  const axisMat = new THREE.LineBasicMaterial({ color: 0xffd26a, transparent:true, opacity:0.95 });
  const axisGeo = new THREE.BufferGeometry().setFromPoints([
    new THREE.Vector3(-0.85, 0, 0.61),
    new THREE.Vector3( 0.85, 0, 0.61),
  ]);
  const axisLine = new THREE.Line(axisGeo, axisMat);
  axisLine.renderOrder = 3;
  lensGroup.add(axisLine);

  // 12 o'clock mark
  const markGeo = new THREE.BoxGeometry(0.08, 0.22, 0.02);
  const markMat = new THREE.MeshStandardMaterial({ color: 0xffd26a, roughness: 0.4 });
  const mark = new THREE.Mesh(markGeo, markMat);
  mark.position.set(0, 0.92, 0.62);
  mark.renderOrder = 4;
  lensGroup.add(mark);

  // blue-light rays (MAX only)
  const rays = new THREE.Group();
  rays.visible = false;
  scene.add(rays);

  function makeRay(x, y, z, len=4){
    const g = new THREE.CylinderGeometry(0.01, 0.08, len, 10, 1, true);
    const m = new THREE.MeshStandardMaterial({ color: 0x4aa3ff, transparent:true, opacity:0.25, emissive:0x1b4faa });
    const ray = new THREE.Mesh(g, m);
    ray.rotation.x = Math.PI/2;
    ray.position.set(x, y, z);
    return ray;
  }
  const rayA = makeRay(-2.2, 0.25, 0.6);
  const rayB = makeRay(-2.2,-0.05, 0.6);
  rays.add(rayA, rayB);

  // ---------- Eye GLB load (blink animation) ----------
  const loader = new GLTFLoader();
  let mixer = null;
  let blinkAction = null;

  statusText.textContent = '렌즈 표시 OK · 눈(GLB) 로딩중…';

  loader.load('./eye_animation.glb', (gltf)=>{
    const model = gltf.scene;

    // Normalize: center & scale to fit
    const box = new THREE.Box3().setFromObject(model);
    const size = box.getSize(new THREE.Vector3()).length();
    const center = box.getCenter(new THREE.Vector3());

    model.position.sub(center);
    const s = 2.6 / (size || 1);
    model.scale.setScalar(s);

    // put eye slightly behind lens
    model.position.z = 0.0;

    eyeGroup.add(model);

    if (gltf.animations && gltf.animations.length){
      mixer = new THREE.AnimationMixer(model);
      blinkAction = mixer.clipAction(gltf.animations[0]); // 첫 클립 사용
      blinkAction.setLoop(THREE.LoopOnce, 1);
      blinkAction.clampWhenFinished = true;
    }

    statusText.innerHTML = '드래그: 회전 · 핀치: 확대 · <b>Blink</b>: ASD 축 안정 연출';
  }, undefined, (e)=>{
    console.error(e);
    // GLB 실패해도 렌즈는 보이게 남아있음
    statusText.innerHTML = '<b style="color:#ff3b30">GLB 로딩 실패</b> : eye_animation.glb 경로/이름/업로드 확인';
  });

  // ---------- ASD logic ----------
  const MISALIGN = THREE.MathUtils.degToRad(18);
  let axisAngle = MISALIGN;
  let axisTarget = MISALIGN;
  let afterMode = false;

  function applyAxis(angle){ lensGroup.rotation.z = angle; }
  applyAxis(axisAngle);

  function setBefore(){
    afterMode = false;
    axisTarget = MISALIGN;
    statusText.innerHTML = '드래그: 회전 · 핀치: 확대 · <b>Blink</b>: ASD 축 안정 (착용 직후)';
  }
  function setAfter(){
    afterMode = true;
    axisTarget = 0;
    statusText.innerHTML = '드래그: 회전 · 핀치: 확대 · <b>축 안정화 완료</b>';
  }

  // ---------- UI Modes ----------
  let product = '1D'; // '1D' | 'MAX'
  let mode = 'ASD';   // 'ASD' | 'PVP' | 'BL'
  let autoSpin = false;

  function openSheet(open=true){
    sheet.classList.toggle('show', open);
  }

  function setProduct(p){
    product = p;
    tab1.classList.toggle('on', product==='1D');
    tab2.classList.toggle('on', product==='MAX');

    if (product==='1D'){
      productPill.textContent = '아큐브 오아시스 원데이 난시';
      btnBL.style.opacity = 0.35;
      btnBL.style.pointerEvents = 'none';
      if (mode==='BL') setMode('ASD');
    } else {
      productPill.innerHTML = '아큐브 오아시스 맥스 난시 <span class="tag">Blue Light</span>';
      btnBL.style.opacity = 1;
      btnBL.style.pointerEvents = 'auto';
    }
    lensMat.color.set(product==='MAX' ? 0x9ae6ff : 0x86ddff);
  }

  function setMode(m){
    mode = m;
    btnASD.classList.toggle('on', mode==='ASD');
    btnPVP.classList.toggle('on', mode==='PVP');
    btnBL.classList.toggle('on',  mode==='BL');

    // reset
    rays.visible = false;
    lensMat.opacity = 0.18;
    lensMat.clearcoat = 0.7;
    axisMat.opacity = 0.95;
    sheetRow.style.display = 'flex';
    ctaBtn.textContent = '순목(눈깜박임)';

    if (mode==='ASD'){
      sheetTitle.textContent = 'ASD 난시 디자인';
      sheetBody.textContent  = '순목(눈깜박임) 시 눈꺼풀과 렌즈의 상호작용으로 난시 축이 빠르게 제자리로 안정됩니다.';
      ctaSub.textContent = '버튼 클릭 시 눈이 깜박이며, 렌즈 축이 안정화되는 연출을 확인합니다.';
    }
    if (mode==='PVP'){
      sheetTitle.textContent = 'PVP 습윤 인자';
      sheetBody.textContent  = 'PVP 습윤 인자가 렌즈 표면 젖음성을 유지하도록 돕고, 수분 유지에 기여합니다. (테스트: 표면 강조 연출)';
      sheetRow.style.display = 'none';
      lensMat.opacity = 0.14;
      lensMat.clearcoat = 0.9;
      axisMat.opacity = 0.35;
      ctaBtn.textContent = 'PVP 보기';
      ctaSub.textContent = '렌즈 표면(젖음성) 포인트를 간단히 확인합니다. (추후 내부 단면/레이어 확장)';
    }
    if (mode==='BL'){
      sheetTitle.textContent = '블루라이트 차단 (MAX)';
      sheetBody.textContent  = '블루라이트가 눈으로 들어오는 경로 중 일부가 렌즈에서 감소/필터링되는 연출을 확인합니다. (테스트: 광선 + 감쇠)';
      sheetRow.style.display = 'none';
      axisMat.opacity = 0.35;
      rays.visible = (product==='MAX');
      ctaBtn.textContent = 'BL 보기';
      ctaSub.textContent = 'MAX 난시에서만 제공되는 블루라이트 관련 기능(테스트)을 확인합니다.';
    }
    openSheet(true);
  }

  // right buttons
  btnRotate.addEventListener('click', ()=>{
    autoSpin = !autoSpin;
    btnRotate.classList.toggle('on', autoSpin);
  });
  btnASD.addEventListener('click', ()=> setMode('ASD'));
  btnPVP.addEventListener('click', ()=> setMode('PVP'));
  btnBL.addEventListener('click', ()=> { if (product==='MAX') setMode('BL'); });

  // bottom tabs
  tab1.addEventListener('click', ()=> setProduct('1D'));
  tab2.addEventListener('click', ()=> setProduct('MAX'));

  // CTA
  ctaBtn.addEventListener('click', ()=>{
    if (mode==='ASD') triggerBlinkASD();
    else openSheet(true);
  });

  // sheet buttons
  btnBlink.addEventListener('click', triggerBlinkASD);
  btnBeforeAfter.addEventListener('click', ()=> { afterMode ? setBefore() : setAfter(); });

  // ---------- Blink + ASD ----------
  let isBlinking = false;

  async function triggerBlinkASD(){
    if (isBlinking) return;
    isBlinking = true;

    openSheet(true);

    // play blink (if exists)
    if (blinkAction){
      try{
        blinkAction.reset();
        blinkAction.play();
      }catch(e){}
    }

    // align axis quickly
    axisTarget = 0;
    await sleep(520);
    setAfter();

    isBlinking = false;
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ---------- Quiz ----------
  const quiz = [
    {
      title: 'Q. ASD 디자인에서 ‘순목’이 하는 역할은?',
      options: ['렌즈를 건조하게 만든다', '축 안정화를 돕는다', '블루라이트를 차단한다'],
      answer: 1
    },
    {
      title: 'Q. 두 제품(원데이 난시/맥스 난시) 공통으로 맞는 것은?',
      options: ['ASD 디자인 + PVP 습윤 인자', '블루라이트 차단', '블루라이트 + UV 차단만 제공'],
      answer: 0
    }
  ];
  let qi = 0;
  let locked = false;

  function showQuiz(){ qi = 0; locked = false; renderQuiz(); modal.classList.add('show'); }
  function closeQuiz(){ modal.classList.remove('show'); }

  function renderQuiz(){
    const q = quiz[qi];
    qnum.textContent = `퀴즈 ${qi+1}/${quiz.length}`;
    qtitle.textContent = q.title;
    [opt0,opt1,opt2].forEach((b,idx)=>{
      b.textContent = q.options[idx];
      b.classList.remove('correct','wrong');
      b.disabled = false;
    });
    locked = false;
    btnNext.textContent = (qi === quiz.length-1) ? '완료' : '다음';
  }
  function markAnswer(idx){
    if (locked) return;
    locked = true;
    const q = quiz[qi];
    [opt0,opt1,opt2].forEach((b,i)=>{
      b.disabled = true;
      if (i === q.answer) b.classList.add('correct');
      if (i === idx && i !== q.answer) b.classList.add('wrong');
    });
  }
  [opt0,opt1,opt2].forEach((b)=> b.addEventListener('click', ()=> markAnswer(parseInt(b.dataset.idx,10))) );
  btnModalClose.addEventListener('click', closeQuiz);
  btnNext.addEventListener('click', ()=>{
    if (!locked){ alert('답을 선택해줘!'); return; }
    if (qi === quiz.length-1){ closeQuiz(); alert('퀴즈 완료! (데모)'); return; }
    qi += 1; renderQuiz();
  });
  tabQuiz.addEventListener('click', showQuiz);

  // ---------- Resize ----------
  function resize(){
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w/h;
    camera.updateProjectionMatrix();
  }
  window.addEventListener('resize', resize);

  // ---------- Loop ----------
  const clock = new THREE.Clock();

  function animate(){
    requestAnimationFrame(animate);
    const dt = Math.min(clock.getDelta(), 0.033);

    controls.update();
    if (mixer) mixer.update(dt);

    // ASD alignment
    const speed = 2.4;
    axisAngle = THREE.MathUtils.lerp(axisAngle, axisTarget, 1 - Math.exp(-speed * dt));
    applyAxis(axisAngle);

    // 360 auto spin
    if (autoSpin){
      root.rotation.y += dt * 0.8;
    }

    // BL pulse
    if (rays.visible){
      const t = performance.now()*0.0012;
      rayA.material.opacity = 0.18 + 0.10*Math.sin(t);
      rayB.material.opacity = 0.18 + 0.10*Math.cos(t*1.1);
      lensMat.opacity = 0.16;
    }

    renderer.render(scene, camera);
  }

  // init
  resize();
  setProduct('1D');
  setMode('ASD');
  setBefore();
  openSheet(true);
  animate();
</script>
</body>
</html>
